# Руководство по взаимодействию с сервисом на основе HTTPS протокола, методом GET

Запросы необходимо отправлять в UTF-8 кодировке. Не стоит использовать URL длиной более 2,000 символов. Но этот параметр зависит от многих факторов и [может различаться в большую или меньшую сторону](https://github.com/dreikanter/paradigm.ru/blob/master/posts/2007-12-19_url-max-length.md). Одинаковые запросы можно отправлять не чаще 1 раза в 1 минуту. В случае ошибки вернется:
```
error: Попытка отправки более одного одинакового запроса в течение минуты
```

# Запрос на отправку сообщения

Отправляется GET-запрос по адресу:
```
https://имя_хоста/sendmessage.php
```

Пример:
```
https://имя_хоста/sendmessage.php?login=ЛОГИН&password=ПАРОЛЬ&phone=ТЕЛЕФОН&send_viber=1&sender_viber=ИМЯ_ОТПРАВИТЕЛЯ_ВАЙБЕР&text_viber=ТЕКСТ_ВАЙБЕР&button_text=ТЕКСТ_КНОПКИ&button_url=ССЫЛКА_КНОПКИ&image_url=ИЗОБРАЖЕНИЕ&send_sms=2&sender_sms=ИМЯ_ОТПРАВИТЕЛЯ_СМС&text_sms=ТЕКСТ_СМС
```
Где:
* **login** – Логин пользователя;
* **password** – Пароль;
* **phone** - Номер абонента, которому адресовано сообщение. Можно несколько телефонов через запятую. Номера в международном формате, например, 79000000001 (для России), 380442589632 (для Украины);
* **send_viber** – Отправлять ли VIBER сообщение. Также является порядком сортировки отправки VIBER сообщения (от меньшего к большему). Может принимать значение от 0 до 9, где 0 - не отправлять VIBER сообщение;
* **sender_viber** – Имя отправителя VIBER. Именно это значение будет выводиться на телефоне абонента в поле от кого сообщение;
* **text_viber** – Текст VIBER сообщения. Не должен превышать более 1000 символов. Обязательный параметр;
* **button_text** – Текст кнопки. Не более 19 символов. Необязательный параметр. При добавлении, обязательно чтоб была указана ссылка кнопки в параметре button_url;
* **button_url** – Ссылка кнопки. Необязательный параметр. При добавлении, обязательно чтоб было указано название кнопки в параметре button_text;
* **image_url** – Ссылка на изображение. Необязательный параметр. В случае добавления изображения, также необходимо наличие кнопки (button_text и button_url);
* **send_sms** – Отправлять ли SMS. Также является порядком сортировки отправки SMS (от меньшего к большему). Может принимать значение от 0 до 9, где 0 - не отправлять SMS;
* **sender_sms** - Отправитель SMS. Именно это значение будет выводиться на телефоне абонента в поле от кого SMS;
* **text_sms** - Текст SMS.

В данном примере, первым будет попытка отправки VIBER сообщения, и в случае недоставки, будет попытка инициализация отправки SMS;

## В случае успешной отправки сообщения

Возвращается ID сообщения  в plainText. Пример:
```
1179038981
```
В случае отправки на несколько номеров возращается ID сообщения через запятую в plaintText. Пример:
```
1178440060,1178440061
```

## В случае ошибки

В случае возникновения ошибки возращается текст ошибки в plainText.

# Проверка статуса сообщения

Отправляетя GET-запрос по адресу:
```
https://имя_хоста/sendmessage.php
```

Пример:
```
https://имя_хоста/sendmessage.php?login=ЛОГИН&password=ПАРОЛЬ&id_message=ID_СООБЩЕНИЯ
```
Где:
* **login** – Логин пользователя;
* **password** – Пароль;
* **id_message** – ID сообщения.

## В случае успешного запроса

В случае успешного запроса возращается статус сообщения в plainText:

* **send** - Статус сообщения не получен;
* **not_deliver** - Сообщение не было доставлено. Конечный статус (не меняется со временем);
* **expired** - Абонент находился не в сети в те моменты, когда делалась попытка доставки. Конечный Статус (не меняется со временем);
* **deliver** - Сообщение доставлено. Конечный статус (не меняется со временем);
* **partly_deliver** - Сообщение было отправлено, но статус так и не был получен. Конечный статус (не меняется со временем). В этом случае для разъяснения причин отсутствия статуса необходимо связаться со службой тех. поддержки.

Пример:
```
deliver
```

## В случае ошибки

В случае возникновения ошибки возвращается текст ошибки в plainText.


# Руководство по взаимодействию с сервисом на основе JSON документов, методом POST

# Общие принципы отправки
На определенный адрес сервера отправляются JSON документы (описание JSON документов, их назначение и адреса сервера приведены ниже). При этом используется POST метод.

Заголовки отправляемых данных должны содержать:
```
Content-Type: application/json; charset=utf-8
```
Кодировка JSON документов UTF-8.

## Пример передачи JSON документа на php

```php
$param = array(
    'login' => 'ЛОГИН',
	'password' => 'ПАРОЛЬ'
);
$param_json = json_encode($param);
// JSON-документ
$href = 'https://имя_хоста/sendmessagejson.php'; // адрес сервера
$ch = curl_init();
curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json','charset=utf-8','Expect:'));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, $param_json);
curl_setopt($ch, CURLOPT_TIMEOUT, 600);
curl_setopt($ch, CURLOPT_URL, $href);
curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, 0);
curl_setopt ($ch, CURLOPT_SSL_VERIFYHOST, 0);
$res = curl_exec($ch);
$result = json_decode($res, true);
curl_close($ch);
print_r($result);
```

## Отправка сообщения
**Адрес сервера:**
```
https://имя_хоста/sendmessagejson.php
```
**JSON-документ:**
```json
{
	"login":"login",
	"password":"password",
	"message":[
		{
			"send_viber":"1",
			"send_sms":"2",
			"name_delivery":"НАЗВАНИЕ_РАССЫЛКИ",
			"time_send":"ВРЕМЯ_ОТПРАВКИ",
			"sender_viber":"ИМЯ_ОТПРАВИТЕЛЯ_ВАЙБЕР",
			"text_viber":"ТЕКСТ_ВАЙБЕР",
			"button_text":"ТЕКСТ_КНОПКИ",
			"button_url":"ССЫЛКА_КНОПКИ",
			"image_url":"ИЗОБРАЖЕНИЕ",
			"sender_sms":"ИМЯ_ОТПРАВИТЕЛЯ_СМС",
			"text_sms":"ТЕКСТ_СМС",
			"phones":[
				{"phone":"79801234567","client_id_message":"111"},
				{"phone":"79800000001","client_id_message":"112"}
			]
		},
		{
			"send_viber":"1",
			"name_delivery":"НАЗВАНИЕ_РАССЫЛКИ_2",
			"sender_viber":"ИМЯ_ОТПРАВИТЕЛЯ_ВАЙБЕР_2",
			"text_viber":"ТЕКСТ_ВАЙБЕР_2",
			"phones":[
				{"phone":"79800000002","client_id_message":"113"}
			]
		},
		{
			"name_delivery":"НАЗВАНИЕ_РАССЫЛКИ_3",
			"sender_viber":"ИМЯ_ОТПРАВИТЕЛЯ_ВАЙБЕР_3",
			"text_viber":"ТЕКСТ_ВАЙБЕР_3",
			"phones":[
				{"phone":"79800000003","client_id_message":"114"}
			]
		}
	]
}
```
**PHP-данные:**
```php
$param = array(
    'login' => 'login',
	'password' => 'password',
	'message' => array(
        array(
            'send_viber' => '1',
			'send_sms' => '2',
			'name_delivery' => 'НАЗВАНИЕ_РАССЫЛКИ',
			'time_send' => 'ВРЕМЯ_ОТПРАВКИ',
			'sender_viber' => 'ИМЯ_ОТПРАВИТЕЛЯ_ВАЙБЕР',
			'text_viber' => 'ТЕКСТ_ВАЙБЕР',
			'button_text' => 'ТЕКСТ_КНОПКИ',
			'button_url' => 'ССЫЛКА_КНОПКИ',
			'image_url' => 'ИЗОБРАЖЕНИЕ',
			'sender_sms' => 'ИМЯ_ОТПРАВИТЕЛЯ_СМС',
			'text_sms' => 'ТЕКСТ_СМС',
			'phones' => array(
				array('phone' => '79801234567', 'client_id_message' => '111'),
				array('phone' => '79800000001', 'client_id_message' => '112')
			)
        ),
		array(
            'send_viber' => '1',
			'name_delivery' => 'НАЗВАНИЕ_РАССЫЛКИ_2',
			'sender_viber' => 'ИМЯ_ОТПРАВИТЕЛЯ_ВАЙБЕР_2',
			'text_viber' => 'ТЕКСТ_ВАЙБЕР_2',
			'phones' => array(
				array('phone' => '79800000002', 'client_id_message' => '113')
			)
        ),
		array(
            'name_delivery' => 'НАЗВАНИЕ_РАССЫЛКИ_3',
			'sender_viber' => 'ИМЯ_ОТПРАВИТЕЛЯ_ВАЙБЕР_3',
			'text_viber' => 'ТЕКСТ_ВАЙБЕР_3',
			'phones' => array(
				array('phone' => '79800000003', 'client_id_message' => '113')
			)
        )
    )
);
```

Где:
* **login** – Логин пользователя;
* **password** – Пароль;
* **message** – Сообщения;
	* **name_delivery** – Название рассылки. Если поле является пустым, по умолчанию - "Шлюз";
	* **time_send** – Желательное время отправки сообщения, в формате: YYYY-MM-DD hh:mm где, YYYY-год, MM-месяц, DD-день, hh-часы, mm-минуты. Например 2017-11-23 13:00. Если поле является пустым, то отправка сообщения происходит сразу;
	* **send_viber** – Отправлять ли VIBER сообщение. Также является порядком сортировки отправки VIBER сообщения (от меньшего к большему). Может принимать значение от 0 до 9, где 0 - не отправлять VIBER сообщение;
	* **sender_viber** – Имя отправителя VIBER. Именно это значение будет выводиться на телефоне абонента в поле от кого сообщение;
	* **text_viber** – Текст VIBER сообщения. Не должен превышать более 1000 символов. Обязательный параметр;
	* **button_text** – Текст кнопки. Не более 19 символов. Необязательный параметр. При добавлении, обязательно чтоб была указана ссылка кнопки в параметре button_url;
	* **button_url** – Ссылка кнопки. Необязательный параметр. При добавлении, обязательно чтоб было указано название кнопки в параметре button_text;
	* **image_url** – Ссылка на изображение. Необязательный параметр. В случае добавления изображения, также необходимо наличие кнопки (button_text и button_url);
	* **send_sms** – Отправлять ли SMS. Также является порядком сортировки отправки SMS (от меньшего к большему). Может принимать значение от 0 до 9, где 0 - не отправлять SMS;
	* **sender_sms** - Отправитель SMS. Именно это значение будет выводиться на телефоне абонента в поле от кого SMS;
	* **text_sms** - Текст SMS;
	* **phones** - Получатели сообщений;
		* **phone** – Номер абонента, которому адресовано сообщение. В международном формате, например, 79000000001 (Для России), 380442589632 (Для Украины) и т.д.;
		* **client_id_message** - ID сообщения на стороне клиента. Число. Необязательный параметр, позволяет избежать повторной отправки. Если раннее с этого аккаунта уже было отправлено сообщение с таким номером, то повторная отправка не производится.

В ответ может быть выдан один из следующих JSON-документов:
### В случае возникновения ошибки в отправляемом JSON-документе

JSON:
```json
{
	"error":"текст ошибки"
}
```
PHP (массив, полученный через php функцию json_decode):
```php
array ('error' => 'текст ошибки')
```

### В случае получения правильного JSON-документа:

JSON:
```json
{
	"message":[
		[
			{"id_message":"ID сообщения в системе для проверки статуса","client_id_message":"ID сообщения на стороне клиента","phone":"Номер телефона получателя сообщения","count_message":"Количество сообщений","count_message":"Количество частей в сообщении","id_viber":"ID VIBER сообщения","id_sms":"ID SMS"},
			{"client_id_message":"ID сообщения на стороне клиента","phone":"Номер телефона получателя сообщения","error":"Ошибка в отправке сообщения на указанный номер"}
		],
		[
			{"id_message":"ID сообщения в системе для проверки статуса","client_id_message":"ID сообщения на стороне клиента","phone":"Номер телефона получателя сообщения","count_message":"Количество сообщений","count_message":"Количество частей в сообщении","id_viber":"ID VIBER сообщения","id_sms":"ID SMS"}
		],
		{"error":"Текст ошибки"}
	]
}
```
PHP (массив, полученный через php функцию json_decode):
```php
Array(
	[message] => Array(
		[0] => Array ( 
			 [0] => Array ( [id_message] => ID сообщения в системе для проверки статуса [client_id_message] => ID сообщения на стороне клиента [phone] => Номер телефона получателя сообщения [count_message] => Количество сообщений [id_viber] => ID VIBER сообщения [id_sms] => ID SMS ),
			 [1] => Array ( [client_id_message] => ID сообщения на стороне клиента [phone] => Номер телефона получателя сообщения [error] => Ошибка в отправке сообщения на указанный номер )
		),
		[1] => Array ( 
			[0] => Array ( [id_message] => ID сообщения в системе для проверки статуса [client_id_message] => ID сообщения на стороне клиента [phone] => Номер телефона получателя сообщения [count_message] => Количество сообщений [id_viber] => ID VIBER сообщения [id_sms] => ID SMS )
		)
		[2] => Array ( 
			[error] => Текст ошибки
		)
	)
)
```

Где:
* **message** – Сообщения;
* **id_message** - ID сообщения в системе для проверки статуса;
* **client_id_message** - ID сообщения на стороне клиента;
* **phone** – Номер абонента, которому адресовано сообщение;
* **count_message** - Количество частей сообщения. Указано количество частей сообщения в первом указанном направлении (viber, sms);
* **id_viber** - ID VIBER сообщения. 0 - если не было отправлено VIBER сообщение;
* **id_sms** - ID SMS сообщения. 0 - если не было отправлено SMS сообщение;
* **error** - Информация об ошибке, если в процессе отправки сообщения произошла ошибка.

## Получение статуса сообщения
**Адрес сервера:**
```
https://имя_хоста/sendmessagejson.php
```
**JSON-документ:**
```json
{
	"login":"login",
	"password":"password",
	"state":[
		{"id_message":"111"},
		{"id_message":"112"}
	]
}
```
**PHP-данные:**
```php
$param = array(
    'login' => 'login',
	'password' => 'password',
	'state' => array(
		array('id_message' => '111'),
		array('id_message' => '112')
	)
);
```

Где:
* **login** – Логин пользователя;
* **password** – Пароль;
* **state** - Статусы сообщений:
	* **id_message** - ID сообщения в системе.

В ответ может быть выдан один из следующих JSON-документов:
### В случае возникновения ошибки в отправляемом JSON-документе

JSON:
```json
{
	"error":"текст ошибки"
}
```
PHP (массив, полученный через php функцию json_decode):
```php
array ('error' => 'текст ошибки')
```

### В случае получения правильного JSON-документа:

JSON:
```json
{
	"message":[
		{"id_message":"ID сообщения в системе ","time_change_state":"Время последней смены состояния","state":"Общий статус сообщения","state_sms":"Статус SMS","state_viber":"Статус VIBER сообщения","num_parts_sms":"Количество часте SMS сообщения","price_sms":"Цена SMS сообщение","price_viber":"Цена VIBER сообщение"},
		{"id_message":"ID сообщения в системе","time_change_state":"Время последней смены состояния","state":"Общий статус сообщения","state_sms":"Статус SMS","state_viber":"Статус VIBER сообщения","num_parts_sms":"Количество часте SMS сообщения","price_sms":"Цена SMS сообщение","price_viber":"Цена VIBER сообщение"}
	]
}
```
PHP (массив, полученный через php функцию json_decode):
```php
Array(
	[message] => Array(
		[0] => Array ( [id_message] => ID сообщения в системе [time_change_state] => Время последней смены состояния [state] => Общий статус сообщения [state_sms] => Статус SMS [state_viber] => Статус VIBER сообщения [num_parts_sms] => Количество часте SMS сообщения [price_sms] => Цена SMS сообщение сообщения [price_viber] => Цена VIBER сообщение ),
		[1] => Array ( [id_message] => ID сообщения в системе [time_change_state] => Время последней смены состояния [state] => Общий статус сообщения [state_sms] => Статус SMS [state_viber] => Статус VIBER сообщения [num_parts_sms] => Количество часте SMS сообщения [price_sms] => Цена SMS сообщение сообщения [price_viber] => Цена VIBER сообщение )
	)
)
```

Где:
* **id_message** - ID сообщения в системе;
* **time_change_state** - Время последней смены состояния, в формате: YYYY-MM-DD hh:mm:ss где, YYYY-год, MM-месяц, DD-день, hh-часы, mm-минуты, ss-секунды. Например 2017-11-23 13:15:25. Поле является пустым, если сообщение с указаным ID не обнаружено;
* **state** – Статус сообщения, может принимать следующие значения:
	* **send** - В процессе работы (не профинализировано);
	* **not_deliver** - Сообщение не было доставлено. Конечный статус (не меняется со временем);
	* **expired** - Абонент находился не в сети в те моменты, когда делалась попытка доставки. Конечный Статус (не меняется со временем);
	* **deliver** - Сообщение доставлено. Конечный статус (не меняется со временем);
	* **partly_deliver** - Сообщение было отправлено, но статус так и не был получен. Конечный статус (не меняется со временем). В этом случае для разъяснения причин отсутствия статуса необходимо связаться со службой тех. поддержки;
	* **ДРУГОЕ** - Если статус сообщения не один из указанных выше, статус означает текст ошибки например "Сообщение с таким ID не принималось";
* **state_sms** - Статус SMS, может принимать следующие значения:
	* **send** - Не было отправлено;
	* **not_deliver** - Сообщение не было доставлено. Конечный статус (не меняется со временем);
	* **expired** - Абонент находился не в сети в те моменты, когда делалась попытка доставки. Конечный Статус (не меняется со временем);
	* **deliver** - Сообщение доставлено. Конечный статус (не меняется со временем);
	* **partly_deliver** - Сообщение было отправлено, но статус так и не был получен. Конечный статус (не меняется со временем). В этом случае для разъяснения причин отсутствия статуса необходимо связаться со службой тех. поддержки;
* **state_viber** - Статус VIBER сообщения, может принимать следующие значения:
	* **send** - Не было отправлено;
	* **not_deliver** - Сообщение не было доставлено. Конечный статус (не меняется со временем);
	* **expired** - Абонент находился не в сети в те моменты, когда делалась попытка доставки. Конечный Статус (не меняется со временем);
	* **deliver** - Сообщение доставлено. Конечный статус (не меняется со временем);
	* **partly_deliver** - Сообщение было отправлено, но статус так и не был получен. Конечный статус (не меняется со временем). В этом случае для разъяснения причин отсутствия статуса необходимо связаться со службой тех. поддержки;
* **num_parts_sms** - Количество частей в SMS, в случае если было отправлено SMS;
* **price_sms** - Списанные средства за SMS, в случае если было отправлено SMS.
* **price_viber** - Списанные средства за VIBER сообщение, в случае если было отправлено VIBER сообщение.
